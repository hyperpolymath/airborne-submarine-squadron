# =================================================================
# GitHub Actions CI/CD - Airborne Submarine Squadron
# =================================================================

name: CI
permissions: read-all

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]

jobs:
  validate:
    name: Validate RSR Compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check documentation
        run: |
          test -f README.md || exit 1
          test -f LICENSE.txt || exit 1
          test -f SECURITY.md || exit 1
          test -f CONTRIBUTING.md || exit 1
          test -f CODE_OF_CONDUCT.md || exit 1
          test -f .well-known/security.txt || exit 1
          test -f .well-known/ai.txt || exit 1
          test -f .well-known/humans.txt || exit 1
          echo "✅ RSR documentation complete"

      - name: Check offline-first
        run: |
          ! grep -r 'Ada.Sockets' src/ || exit 1
          ! grep -r 'HTTP' src/ || exit 1
          echo "✅ No network dependencies"

      - name: Check licensing
        run: |
          grep -q "MIT" LICENSE.txt || exit 1
          grep -q "Palimpsest" LICENSE.txt || exit 1
          echo "✅ Dual licensing verified"

  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Install GNAT (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y gnat gprbuild

      - name: Install GNAT (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install gcc
          # Note: macOS build may require AdaCore GNAT

      - name: Build debug
        run: |
          mkdir -p obj bin
          gprbuild -P submarine_squadron.gpr -XMODE=debug || true

      - name: Build release
        run: |
          mkdir -p obj bin
          gprbuild -P submarine_squadron.gpr -XMODE=release || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: runner.os == 'Linux'
        with:
          name: submarine-squadron-${{ runner.os }}
          path: bin/main
          if-no-files-found: warn

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Install GNAT
        run: |
          sudo apt-get update
          sudo apt-get install -y gnat gprbuild

      - name: Build tests
        run: |
          mkdir -p obj bin
          gprbuild -P tests/test_submarine.gpr || echo "Test build: TODO"

      - name: Run unit tests
        run: |
          if [ -f bin/test_submarine ]; then
            ./bin/test_submarine
          else
            echo "Unit tests: TODO"
          fi

  security:
    name: Security Checks
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check for unsafe operations
        run: |
          ! grep -r 'Unchecked_' src/ || exit 1
          ! grep -r 'pragma Suppress' src/ || exit 1
          echo "✅ No unsafe operations"

      - name: Check for secrets
        run: |
          ! grep -rE '(password|secret|api.?key)\s*[:=]' src/ || exit 1
          echo "✅ No hardcoded secrets"

  nix:
    name: Nix Build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v24
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Build with Nix
        run: nix build

      - name: Check with Nix
        run: nix flake check
